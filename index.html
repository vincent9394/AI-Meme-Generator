<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meme Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 dark:text-white">Meme Generator</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">Choose a category, or write your own prompt to create a meme!</p>
        </header>

        <!-- Category Selection -->
        <div id="category-selection" class="mb-8 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-center">1. Pick a Category</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button data-category="Funny" class="category-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">🤣 Funny</button>
                <button data-category="Humor" class="category-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">😄 Humor</button>
                <button data-category="Academic" class="category-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">🎓 Academic</button>
                <button data-category="Sad" class="category-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">😢 Sad</button>
                <button data-category="Animals" class="category-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">🐶 Animals</button>
                <button data-category="Gaming" class="category-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">🎮 Gaming</button>
                <button data-category="Work" class="category-btn bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">💼 Work</button>
                <button data-category="Relationship" class="category-btn bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">❤️ Relationship</button>
            </div>
        </div>

        <!-- Custom Prompt Section -->
        <div id="custom-prompt-section" class="mt-8 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-center">Or... Create Your Own!</h2>
            <textarea id="custom-prompt-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" rows="3" placeholder="e.g., A cat wearing a tiny chef hat, looking proud of a burnt piece of toast."></textarea>
            <button id="custom-generate-btn" class="mt-4 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Generate Custom Meme</button>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden flex-col items-center justify-center my-12">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-medium text-gray-600 dark:text-gray-300">Generating your memes...</p>
        </div>
        
        <!-- Message Box -->
        <div id="message-box" class="hidden p-4 my-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
            <span class="font-medium">Error!</span> <span id="message-content"></span>
        </div>

        <!-- Results Display -->
        <div id="results-container" class="hidden mt-12">
             <h2 id="results-title" class="text-3xl font-bold mb-8 text-center"></h2>
            <div id="results-grid" class="grid md:grid-cols-2 gap-8">
                <!-- Internet Meme Card -->
                <div id="internet-meme-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 bg-gray-200 dark:bg-gray-700">
                        <h3 class="text-xl font-bold text-center text-gray-800 dark:text-white">Found on The Internet</h3>
                    </div>
                    <div class="p-4">
                        <img id="internet-meme-img" src="https://placehold.co/600x400/e2e8f0/4a5568?text=Select+a+Category" alt="Internet Meme" class="w-full h-auto rounded-lg object-contain" style="min-height: 300px;">
                    </div>
                </div>

                <!-- Generated Meme Card -->
                <div id="generated-meme-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 bg-gray-200 dark:bg-gray-700">
                        <h3 class="text-xl font-bold text-center text-gray-800 dark:text-white">Freshly Generated For You</h3>
                    </div>
                    <div class="p-4">
                        <img id="generated-meme-img" src="https://placehold.co/600x400/e2e8f0/4a5568?text=Select+a+Category" alt="Generated Meme" class="w-full h-auto rounded-lg object-contain" style="min-height: 300px;">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const categoryButtons = document.querySelectorAll('.category-btn');
            const customPromptInput = document.getElementById('custom-prompt-input');
            const customGenerateBtn = document.getElementById('custom-generate-btn');
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsContainer = document.getElementById('results-container');
            const resultsTitle = document.getElementById('results-title');
            const resultsGrid = document.getElementById('results-grid');
            const internetMemeCard = document.getElementById('internet-meme-card');
            const generatedMemeCard = document.getElementById('generated-meme-card');
            const internetMemeImg = document.getElementById('internet-meme-img');
            const generatedMemeImg = document.getElementById('generated-meme-img');
            const messageBox = document.getElementById('message-box');
            const messageContent = document.getElementById('message-content');

            // Pre-selected "internet memes" for each category
            const internetMemes = {
                'Funny': 'https://i.imgflip.com/1bij.jpg', // Distracted Boyfriend
                'Humor': 'https://i.imgflip.com/2/1ur9b0.jpg', // Drakeposting
                'Academic': 'https://i.imgflip.com/345v97.jpg', // Woman yelling at cat
                'Sad': 'https://i.imgflip.com/1g8my4.jpg', // Crying Pablo Escobar
                'Animals': 'https://i.imgflip.com/2ch644.jpg', // Surprised Koala
                'Gaming': 'https://i.imgflip.com/1l0xtp.jpg', // Stressed Gamer
                'Work': 'https://i.imgflip.com/1h24vj.jpg', // "I have no idea what I'm doing" Dog
                'Relationship': 'https://i.imgflip.com/49wh6g.jpg' // Panik Kalm Panik
            };

            // Add click listeners to all category buttons
            categoryButtons.forEach(button => {
                button.addEventListener('click', handleCategoryClick);
            });
            
            // Add click listener for the custom prompt button
            customGenerateBtn.addEventListener('click', handleCustomGenerate);

            /**
             * Handles the click event on a category button.
             */
            async function handleCategoryClick(event) {
                const category = event.target.dataset.category;
                if (!category) return;

                // --- Prepare UI for generation ---
                showLoading();
                resultsTitle.textContent = "Here Are Your Memes!";
                internetMemeCard.classList.remove('hidden');
                resultsGrid.classList.remove('md:grid-cols-1');
                resultsGrid.classList.add('md:grid-cols-2');

                // --- Set the internet meme image immediately ---
                internetMemeImg.src = internetMemes[category];
                internetMemeImg.onerror = () => {
                    internetMemeImg.src = `https://placehold.co/600x400/e2e8f0/4a5568?text=Error+Loading+Image`;
                };

                // --- Generate the new meme ---
                const prompt = `A funny internet meme about the topic: '${category}'. The meme should have large, bold text at the top or bottom, in the style of classic image macro memes.`;
                await generateAndDisplayMeme(prompt);
            }
            
            /**
             * Handles the generation from a custom user prompt.
             */
            async function handleCustomGenerate() {
                const prompt = customPromptInput.value.trim();
                if (!prompt) {
                    showError("Please enter a prompt for your meme!");
                    return;
                }
                
                // --- Prepare UI for generation ---
                showLoading();
                resultsTitle.textContent = "Your Custom Meme!";
                internetMemeCard.classList.add('hidden');
                resultsGrid.classList.remove('md:grid-cols-2');
                resultsGrid.classList.add('md:grid-cols-1');
                
                // --- Generate the new meme ---
                await generateAndDisplayMeme(prompt);
            }

            /**
             * Main logic to generate and display a meme image.
             * @param {string} prompt - The prompt to send to the model.
             */
            async function generateAndDisplayMeme(prompt) {
                 try {
                    const generatedImageUrl = await generateImageFromServer(prompt);
                    if (generatedImageUrl) {
                        generatedMemeImg.src = generatedImageUrl;
                        showResults();
                    } else {
                        throw new Error("Image generation failed to return a valid image.");
                    }
                } catch (error) {
                    console.error('Error generating meme:', error);
                    showError('Could not generate the meme. Please try again later.');
                    generatedMemeImg.src = `https://placehold.co/600x400/e2e8f0/4a5568?text=Generation+Failed`;
                    showResults(); // Still show results container to display the error image
                } finally {
                    hideLoading();
                }
            }

            /**
             * Calls our own back-end serverless function to securely generate an image.
             * @param {string} prompt - The prompt for the image generation.
             * @returns {Promise<string|null>} The base64 data URL of the image, or null if it fails.
             */
            async function generateImageFromServer(prompt) {
                // This is the new endpoint for our own serverless function.
                const apiUrl = '/api/generate-meme';

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt }),
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                return result.imageUrl;
            }
            
            // --- UI Helper Functions ---
            function showLoading() {
                resultsContainer.classList.add('hidden');
                messageBox.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.classList.add('flex');
            }
            
            function hideLoading() {
                loadingIndicator.classList.add('hidden');
                loadingIndicator.classList.remove('flex');
            }

            function showResults() {
                resultsContainer.classList.remove('hidden');
            }

            function showError(message) {
                messageContent.textContent = message;
                messageBox.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
